$(document).ready(function() {

  'use strict';

  // variables
  var form = $('.validate-form'),
    flat_picker = $('.flatpickr'),
    accountUploadImg = $('#account-upload-img'),
    accountUploadBtn = $('#account-upload'),
    changePassFormId = $("#change-password");

  // Update user photo on click of button
  if (accountUploadBtn) {
    accountUploadBtn.on('change', function (e) {
      var reader = new FileReader(),
        files = e.target.files;
      reader.onload = function () {
        if (accountUploadImg) {
          accountUploadImg.attr('src', reader.result);
        }
      };
      reader.readAsDataURL(files[0]);
    });
  }

  // flatpickr init
  if (flat_picker.length) {
    flat_picker.flatpickr({
      onReady: function (selectedDates, dateStr, instance) {
        if (instance.isMobile) {
          $(instance.mobileInput).attr('step', null);
        }
      }
    });
  }

  // jQuery Validation
  // --------------------------------------------------------------------
  if (form.length) {
    form.each(function () {
      var $this = $(this);

      $this.validate({
        rules: {
          username: {
            required: true
          },
          name: {
            required: true
          },
          email: {
            required: true,
            email: true
          },
          password: {
            required: true
          },
          company: {
            required: true
          },
          'new-password': {
            required: true,
            minlength: 6
          },
          'confirm-new-password': {
            required: true,
            minlength: 6,
            equalTo: '#account-new-password'
          },
          dob: {
            required: true
          },
          phone: {
            required: true
          },
          website: {
            required: true
          },
          'select-country': {
            required: true
          }
        }
      });
      $this.on('submit', function (e) {
        
      });
    });
  }


  	if (changePassFormId.length) {
	    changePassFormId.each(function () {
	      var $this = $(this);
	      $this.validate({
	        rules: {
	          'current_password': {
	            required: true
	          },
	          'new_password': {
	            required: true,
	            minlength: 6
	          },
	          'confirm-new-password': {
	            required: true,
	            minlength: 6,
	            equalTo: '#new_password'
	          },
	        }
	      });
		    $this.on('submit', function (e) {
		    	e.preventDefault();
	        	changePassword();
	  		});  
    	});
  	}


	function changePassword(){
		
		openLoader();

		 var formData = {
            current_password: jQuery('#current_password').val(),
            new_password: jQuery('#new_password').val(),
        };
        var type = "POST";
        var ajaxurl = changePassFormId.attr('action');
        $.ajax({
            type: type,
            url: ajaxurl,
            data: formData,
            dataType: 'json',
            success: function(data) {
            	closeLoader();
                let res = data.response;
                if(res.status_code == 1000){
                    Swal.fire({
                        title: 'success',
                        text: res.message,
                        icon: 'success',
                        customClass: {
                          confirmButton: 'btn btn-primary'
                        },
                        buttonsStyling: false
                    });

                }
                else if(res.status_code == 7001){
                	
                    Swal.fire({
                        title: 'Error!',
                        text: res.message,
                        icon: 'error',
                        customClass: {
                          confirmButton: 'btn btn-primary'
                        },
                        buttonsStyling: false
                    });
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: ' Something went wrong!',
                        icon: 'error',
                        customClass: {
                          confirmButton: 'btn btn-primary'
                        },
                        buttonsStyling: false
                    });
                }
                changePassFormId.trigger("reset");
            },
            error: function(data) {
            	closeLoader();
                Swal.fire({
                    title: 'Error!',
                    text: ' Something went wrong!',
                    icon: 'error',
                    customClass: {
                      confirmButton: 'btn btn-primary'
                    },
                    buttonsStyling: false
                });
                changePassFormId.trigger("reset");
            }
        });
	}

  $(document).on('click', '#resendOTP', function(){
    if($('#account-e-mail').val() != null){
      Swal.fire(areYouSure('Are You Sure Want To Resend OTP?','Yes')).then(function (result) {
            if (result.value) {
                resendOTP();
            } 
            else if (result.dismiss === Swal.DismissReason.cancel) {
              $('.modal').modal('hide');
            }
            });
          }
          else{
            errorModal('Please enter your email first!');
          }
        
    });
    function resendOTP()
    {
        openLoader();
        var type = "POST";
        var ajaxurl = getListingUrl;
        $.ajax({
            type: type,
            url: ajaxurl,
            data:{'email':$('#account-e-mail').val()},
            dataType: 'json',
            success: function(data) {
                closeLoader();
                let res = data.response;
                
                    if(res.status_code == 3013){
                        successModal(res.message, 'OTP Resent!');
                        $('.modal').modal('hide');
                        
                    } 
                    else if(res.status_code == 3014) {
                         errorModal(err.response.message);
                    }
                    else{
                       errorModal('Something went wrong!');
                    }

                },
              
            error: function(data) {
                closeLoader();
                errorModal('Something went wrong!');
            }
        });
    };

    // verifyotp
    $(document).on('click', '#btnVerifyOtp', function(){
      var varifyOtp = $('#verifyotp').val();
      var otpCheck = false;
      if(varifyOtp != ''){
        if(varifyOtp.match(/^[0-9]+$/) != null){
          if(varifyOtp.length == 6){
            otpCheck = true;
          }
        }
      }
      else{
        errorModal("Please Enter OTP!");
        return false;
      }

      if(otpCheck){
        verifyOTP();  
      }
      else{
        errorModal('Invalid OTP!');
      }
    });

    function verifyOTP()
    {
        openLoader();
        var type = "POST";
        var ajaxurl = verifyUrl;
        $.ajax({
            type: type,
            url: ajaxurl,
            data:{'otp':$('#verifyotp').val()},
            dataType: 'json',
            success: function(data) {
                closeLoader();
                let res = data.response;
                    if(res.status_code == 3015){
                        successModal(res.message, 'OTP Verify Successfully!');
                        $('.modal').modal('hide');
                        setTimeout(function(){
                          window.location.reload();
                        },5000); 
                    } 
                    else if(res.status_code == 3016) {
                         errorModal(err.response.message);
                    }
                    else{
                       errorModal('Something went wrong!');
                    }

                },
              
            error: function(data) {
                closeLoader();
                errorModal('Something went wrong!');
            }
        });
    };

});